import { useState, useEffect, useRef, ChangeEvent } from 'react';
import { useAuth } from '@/hooks/use-auth';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { useToast } from '@/hooks/use-toast';
import { toast } from '@/hooks/use-toast';
import { apiRequest } from '@/lib/queryClient';
import { INDUSTRY_OPTIONS } from '@/lib/constants';
import { format } from 'date-fns';
import { Link } from 'wouter';
import { Loader2, CreditCard, CheckCircle, CalendarIcon, ExternalLink, Newspaper } from 'lucide-react';
import { Calendar } from '@/components/ui/calendar';
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';

// UI Components
import { 
  Card, 
  CardContent,
  CardHeader,
  CardTitle,
  CardDescription 
} from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { 
  Form, 
  FormControl, 
  FormField, 
  FormItem, 
  FormLabel, 
  FormMessage 
} from '@/components/ui/form';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue
} from '@/components/ui/select';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import {
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger,
} from "@/components/ui/accordion";
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';


// Form validation schema
const profileFormSchema = z.object({
  fullName: z.string().min(2, { message: "Full name is required" }),
  bio: z.string().min(10, { message: "Please provide a short bio (at least 10 characters)" }),
  location: z.string().min(2, { message: "Location is required" }),
  industry: z.string().min(1, { message: "Please select your industry" }),
  linkedIn: z.string().url({ message: "Please enter a valid LinkedIn URL" }).optional().or(z.literal("")),
  instagram: z.string().url({ message: "Please enter a valid Instagram URL" }).optional().or(z.literal("")),
  twitter: z.string().url({ message: "Please enter a valid X.com URL" }).optional().or(z.literal("")),
  website: z.string().url({ message: "Please enter a valid website URL" }).optional().or(z.literal("")),
  pastPrLinks: z.string().optional(),
  avatar: z.string().optional(),
});

export default function AccountPage() {
  const { user } = useAuth();
  const [subscriptionModalOpen, setSubscriptionModalOpen] = useState(false);
  const [cancelModalOpen, setCancelModalOpen] = useState(false);
  const [cancellingSubscription, setCancellingSubscription] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [activeSection, setActiveSection] = useState("profile"); // Default to profile section
  const [activeTab, setActiveTab] = useState("info"); // Default to info tab
  const [sidebarOpen, setSidebarOpen] = useState(true); // Control sidebar visibility
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [avatarPreview, setAvatarPreview] = useState<string>("");
  const fileInputRef = useRef<HTMLInputElement>(null);
  const queryClient = useQueryClient();
  
  // Media coverage modal state
  const [addMediaModalOpen, setAddMediaModalOpen] = useState(false);
  const [mediaDate, setMediaDate] = useState<Date | undefined>(new Date());
  
  // Custom past media coverage items (separate from pitches/placements)
  const [customMediaItems, setCustomMediaItems] = useState<any[]>([]);
  
  // Media coverage form schema
  const mediaCoverageSchema = z.object({
    title: z.string().min(2, { message: "Title is required" }),
    publication: z.string().min(2, { message: "Publication name is required" }),
    url: z.string().url({ message: "Please enter a valid URL" }),
    date: z.date({
      required_error: "Publication date is required",
    }),
  });

  // Define subscription type
  type SubscriptionData = {
    isPremium: boolean;
    status: string;
    expiresAt: string | null;
    subscriptionId: string | null;
  };

  // Fetch subscription status
  const { data: subscription, isLoading: isLoadingSubscription } = useQuery<SubscriptionData>({
    queryKey: [`/api/user/${user?.id}/subscription`],
    enabled: !!user?.id,
  });

  // Fetch user's successful placements
  const { data: successfulPlacements, isLoading: isLoadingPlacements } = useQuery<any[]>({
    queryKey: [`/api/users/${user?.id}/placements`],
    enabled: !!user?.id,
  });

  // Initialize the form with the user's data
  const form = useForm<z.infer<typeof profileFormSchema>>({
    resolver: zodResolver(profileFormSchema),
    defaultValues: {
      fullName: user?.fullName || "",
      bio: user?.bio || "",
      location: user?.location || "",
      industry: user?.industry || "",
      linkedIn: user?.linkedIn || "",
      instagram: user?.instagram || "",
      twitter: user?.twitter || user?.facebook || "",
      website: user?.website || "",
      pastPrLinks: user?.pastPrLinks || "",
    },
  });

  // Update form values when user data is loaded
  useEffect(() => {
    if (user) {
      form.reset({
        fullName: user.fullName || "",
        bio: user.bio || "",
        location: user.location || "",
        industry: user.industry || "",
        linkedIn: user.linkedIn || "",
        instagram: user.instagram || "",
        twitter: user.twitter || user.facebook || "",
        website: user.website || "",
        pastPrLinks: user.pastPrLinks || "",
      });
      
      // Set avatar preview if user has an avatar
      if (user.avatar) {
        setAvatarPreview(user.avatar);
      }
    }
  }, [user, form]);

  const formatDate = (dateString: string | null | undefined) => {
    if (!dateString) return 'N/A';
    try {
      return format(new Date(dateString), 'MMMM d, yyyy');
    } catch (e) {
      return 'Invalid date';
    }
  };

  // Handle avatar file selection
  const handleAvatarChange = (e: ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) {
      const file = e.target.files[0];
      // 5MB file size limit
      if (file.size > 5 * 1024 * 1024) {
        toast({
          title: "File too large",
          description: "Maximum file size is 5MB",
          variant: "destructive",
        });
        return;
      }
      
      // Only accept image files
      if (!file.type.startsWith('image/')) {
        toast({
          title: "Invalid file type",
          description: "Please upload an image file",
          variant: "destructive",
        });
        return;
      }
      
      setAvatarFile(file);
      
      // Create a preview
      const reader = new FileReader();
      reader.onloadend = () => {
        if (typeof reader.result === "string") {
          setAvatarPreview(reader.result);
        }
      };
      reader.readAsDataURL(file);
    }
  };

  // Trigger file input click
  const handleAvatarClick = () => {
    if (fileInputRef.current) {
      fileInputRef.current.click();
    }
  };

  // Profile update mutation
  const profileUpdateMutation = useMutation({
    mutationFn: async (data: z.infer<typeof profileFormSchema>) => {
      // First upload avatar if changed
      if (avatarFile && user) {
        const formData = new FormData();
        formData.append('avatar', avatarFile);
        
        const response = await fetch(`/api/users/${user.id}/avatar`, {
          method: 'POST',
          body: formData,
        });
        
        if (!response.ok) {
          throw new Error('Failed to upload avatar');
        }
        
        const result = await response.json();
        data = { ...data, avatar: result.fileUrl };
      }
      
      if (!user) throw new Error("User not found");
      
      return await apiRequest('PATCH', `/api/users/${user.id}/profile`, data);
    },
    onSuccess: () => {
      // Invalidate user query to refresh data
      queryClient.invalidateQueries({ queryKey: ['/api/user'] });
      
      toast({
        title: "Profile Updated",
        description: "Your profile has been successfully updated",
      });
      
      setIsEditing(false);
    },
    onError: (error: Error) => {
      toast({
        title: "Update Failed",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  // Cancel subscription mutation
  // Media coverage form
  const mediaForm = useForm<z.infer<typeof mediaCoverageSchema>>({
    resolver: zodResolver(mediaCoverageSchema),
    defaultValues: {
      title: "",
      publication: "",
      url: "",
      date: new Date(),
    },
  });
  
  // Add media coverage handler
  const handleAddMedia = (data: z.infer<typeof mediaCoverageSchema>) => {
    // Create a new media item with generated ID
    const newItem = {
      id: Date.now().toString(),
      ...data,
      createdAt: new Date().toISOString(),
    };
    
    // Add to local state
    setCustomMediaItems(prev => [newItem, ...prev]);
    
    // Could also save to backend if needed
    // apiRequest('POST', `/api/users/${user.id}/custom-media`, newItem);
    
    // Close modal and reset form
    setAddMediaModalOpen(false);
    mediaForm.reset();
    
    toast({
      title: "Media Added",
      description: "Your media coverage has been added to your profile",
    });
  };
  
  // Cancel subscription mutation
  const cancelSubscriptionMutation = useMutation({
    mutationFn: async () => {
      if (!user?.id) throw new Error("User not found");
      if (!subscription?.subscriptionId) throw new Error("No active subscription found");
      
      return await apiRequest('POST', `/api/users/${user.id}/subscription/cancel`, null);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: [`/api/user/${user?.id}/subscription`] });
      setCancelModalOpen(false);
      toast({
        title: "Subscription Cancelled",
        description: "Your subscription has been cancelled and will end at the end of the billing period",
      });
    },
    onError: (error: Error) => {
      toast({
        title: "Cancellation Failed",
        description: error.message,
        variant: "destructive",
      });
    },
    onSettled: () => {
      setCancellingSubscription(false);
    }
  });

  if (!user) {
    return (
      <div className="flex justify-center items-center min-h-screen">
        <Loader2 className="h-8 w-8 animate-spin text-qpurple" />
      </div>
    );
  }

  const onSubmit = (data: z.infer<typeof profileFormSchema>) => {
    profileUpdateMutation.mutate(data);
  };

  const handleCancelSubscription = () => {
    setCancellingSubscription(true);
    cancelSubscriptionMutation.mutate();
  };

  return (
    <div className="flex min-h-screen bg-gray-50 relative">
      {/* Mobile overlay */}
      {sidebarOpen && (
        <div 
          className="lg:hidden fixed inset-0 bg-black bg-opacity-30 z-30"
          onClick={() => setSidebarOpen(false)} 
          aria-hidden="true"
        />
      )}
      {/* Mobile Sidebar Toggle */}
      <button
        onClick={() => setSidebarOpen(!sidebarOpen)}
        className="lg:hidden fixed top-4 left-4 z-50 p-2 rounded-md bg-white shadow-md"
        aria-label="Toggle sidebar"
      >
        <svg
          className="h-5 w-5 text-gray-600"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          {sidebarOpen ? (
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
          ) : (
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
          )}
        </svg>
      </button>

      {/* Sidebar - Fixed width */}
      <div 
        className={`w-72 min-h-screen bg-white border-r border-gray-200 p-6 fixed overflow-y-auto transition-transform duration-300 ease-in-out z-40 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'} lg:translate-x-0`} 
        style={{ maxHeight: '100vh' }}
      >
        <div className="space-y-6">
          {/* Profile Avatar & Basic Info */}
          <div className="flex flex-col items-center text-center">
            <div 
              className="w-32 h-32 rounded-full bg-gray-100 mb-4 relative group cursor-pointer"
              onClick={() => isEditing && handleAvatarClick()}
            >
              {(user.avatar || avatarPreview) ? (
                <img 
                  src={avatarPreview || user.avatar || ''} 
                  alt={user.fullName || 'Profile'} 
                  className="w-full h-full object-cover rounded-full"
                  onError={(e) => {
                    // Fallback if image fails to load
                    e.currentTarget.style.display = 'none';
                    e.currentTarget.parentElement.querySelector('.fallback-avatar').style.display = 'flex';
                  }}
                />
              ) : (
                <div className="flex items-center justify-center w-full h-full rounded-full bg-gray-200 text-gray-600 font-bold text-4xl fallback-avatar">
                  {user.fullName ? user.fullName.charAt(0).toUpperCase() : 'U'}
                </div>
              )}
              {isEditing && (
                <div className="absolute inset-0 rounded-full bg-black bg-opacity-0 flex items-center justify-center transition-all duration-200 group-hover:bg-opacity-30">
                  <span className="text-white opacity-0 group-hover:opacity-100 text-sm font-medium">
                    Change Photo
                  </span>
                </div>
              )}
            </div>
            <input
              type="file"
              ref={fileInputRef}
              onChange={handleAvatarChange}
              className="hidden"
              accept="image/*"
            />
            <h2 className="text-xl font-bold">{user.fullName}</h2>
            <p className="text-sm text-gray-500">@{user.username}</p>
            {user.location && (
              <p className="text-sm text-gray-500 mt-1">{user.location}</p>
            )}
            
            {/* Edit Profile Button */}
            <Button 
              variant="outline" 
              size="sm" 
              className="mt-4 w-full"
              onClick={() => setIsEditing(true)}
            >
              <svg className="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
              </svg>
              Edit Profile
            </Button>
          </div>

          {/* Navigation Menu */}
          <div className="pt-4">
            <h3 className="text-xs font-semibold uppercase tracking-wider text-gray-500 mb-3">Navigation</h3>
            <nav className="space-y-1">
              <a 
                href="/account" 
                className="flex items-center py-2 px-3 text-sm font-medium rounded-md bg-blue-50 text-blue-700"
              >
                <svg className="h-4 w-4 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                Profile
              </a>
              
              <a 
                href="/opportunities" 
                className="flex items-center py-2 px-3 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-50"
              >
                <svg className="h-4 w-4 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
                </svg>
                Opportunities
              </a>
              
              <a 
                href="/pitches" 
                className="flex items-center py-2 px-3 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-50"
              >
                <svg className="h-4 w-4 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                </svg>
                My Pitches
              </a>
            </nav>
          </div>

          {/* Account Settings Section */}
          <div className="pt-4">
            <h3 className="text-xs font-semibold uppercase tracking-wider text-gray-500 mb-3">Account Settings</h3>
            <div className="space-y-1">
              <button 
                onClick={() => setSubscriptionModalOpen(true)}
                className="flex w-full items-center py-2 px-3 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-50"
              >
                <svg className="h-4 w-4 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                </svg>
                Subscription & Billing
              </button>
              
              <button 
                className="flex w-full items-center py-2 px-3 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-50"
              >
                <svg className="h-4 w-4 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                </svg>
                Password & Security
              </button>
            </div>
          </div>
          
          {/* Help & Support Section */}
          <div className="pt-4">
            <h3 className="text-xs font-semibold uppercase tracking-wider text-gray-500 mb-3">Help & Support</h3>
            <div className="space-y-1">
              <a 
                href="mailto:support@quotebid.com" 
                className="flex items-center py-2 px-3 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-50"
              >
                <svg className="h-4 w-4 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
                Contact Support
              </a>
              
              <a 
                href="https://calendly.com/quotebid/consultation" 
                target="_blank" 
                rel="noopener noreferrer"
                className="flex items-center py-2 px-3 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-50"
              >
                <svg className="h-4 w-4 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                Book a Call
              </a>
              
              <a 
                href="https://quotebid.com/help" 
                target="_blank" 
                rel="noopener noreferrer"
                className="flex items-center py-2 px-3 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-50"
              >
                <svg className="h-4 w-4 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Help Center
              </a>
            </div>
          </div>
          
          {/* Help text at bottom of sidebar */}
          <div className="pt-6 mt-6 border-t border-gray-200">
            <p className="text-xs text-gray-500 text-center">
              Need help? <a href="mailto:support@quotebid.com" className="text-blue-600 hover:underline">Contact Support</a>
            </p>
          </div>
        </div>
      </div>

      {/* Main Content - Responsive margin to account for sidebar */}
      <div className={`lg:ml-72 transition-all duration-300 ease-in-out flex-1 p-8 ${sidebarOpen ? 'ml-72' : 'ml-0'}`}>
        <div className="max-w-4xl mx-auto">
          <h1 className="text-2xl font-bold mb-6">Profile Dashboard</h1>
          
          {isEditing ? (
            <div>
              <div className="flex justify-between items-center mb-6">
                <h1 className="text-2xl font-bold">Edit Profile</h1>
                <Button 
                  variant="ghost" 
                  onClick={() => setIsEditing(false)}
                  disabled={profileUpdateMutation.isPending}
                >
                  Cancel
                </Button>
              </div>

              <Card>
                <CardHeader>
                  <CardTitle>Profile Information</CardTitle>
                  <CardDescription>
                    This information will be used by journalists to understand your expertise
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  <Form {...form}>
                    <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
                      {/* Basic info section */}
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <FormField
                          control={form.control}
                          name="fullName"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Full Name*</FormLabel>
                              <FormControl>
                                <Input placeholder="John Smith" {...field} />
                              </FormControl>
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                        
                        <FormField
                          control={form.control}
                          name="location"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Location*</FormLabel>
                              <FormControl>
                                <Input placeholder="New York, NY" {...field} />
                              </FormControl>
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                      </div>
                      
                      {/* Bio section */}
                      <FormField
                        control={form.control}
                        name="bio"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Professional Bio*</FormLabel>
                            <FormControl>
                              <Textarea 
                                placeholder="Describe your background, expertise, and what you can offer to journalists..."
                                className="min-h-[120px]"
                                {...field}
                              />
                            </FormControl>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                      
                      {/* Industry selection */}
                      <FormField
                        control={form.control}
                        name="industry"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Primary Industry*</FormLabel>
                            <Select 
                              onValueChange={field.onChange} 
                              defaultValue={field.value}
                            >
                              <FormControl>
                                <SelectTrigger>
                                  <SelectValue placeholder="Select your industry" />
                                </SelectTrigger>
                              </FormControl>
                              <SelectContent>
                                {INDUSTRY_OPTIONS.map((option) => (
                                  <SelectItem key={option.value} value={option.value}>
                                    {option.label}
                                  </SelectItem>
                                ))}
                              </SelectContent>
                            </Select>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                      
                      {/* Social links section */}
                      <div>
                        <h3 className="text-lg font-medium mb-4">Social Media (Optional)</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          <FormField
                            control={form.control}
                            name="linkedIn"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel>LinkedIn</FormLabel>
                                <FormControl>
                                  <Input placeholder="https://linkedin.com/in/username" {...field} />
                                </FormControl>
                                <FormMessage />
                              </FormItem>
                            )}
                          />
                          
                          <FormField
                            control={form.control}
                            name="website"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel>Website</FormLabel>
                                <FormControl>
                                  <Input placeholder="https://yourwebsite.com" {...field} />
                                </FormControl>
                                <FormMessage />
                              </FormItem>
                            )}
                          />
                          
                          <FormField
                            control={form.control}
                            name="instagram"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel>Instagram</FormLabel>
                                <FormControl>
                                  <Input placeholder="https://instagram.com/username" {...field} />
                                </FormControl>
                                <FormMessage />
                              </FormItem>
                            )}
                          />
                          
                          <FormField
                            control={form.control}
                            name="twitter"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel>X Profile</FormLabel>
                                <FormControl>
                                  <Input placeholder="https://x.com/username" {...field} />
                                </FormControl>
                                <FormMessage />
                              </FormItem>
                            )}
                          />
                        </div>
                      </div>
                      
                      {/* Past PR Links */}
                      <FormField
                        control={form.control}
                        name="pastPrLinks"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Past PR Links (Optional)</FormLabel>
                            <FormControl>
                              <Textarea 
                                placeholder="Share links to any past media coverage or articles you've been featured in..."
                                className="min-h-[120px]"
                                {...field}
                              />
                            </FormControl>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                      
                      <div className="flex justify-end gap-3">
                        <Button 
                          type="button" 
                          variant="outline"  
                          onClick={() => setIsEditing(false)}
                          disabled={profileUpdateMutation.isPending}
                        >
                          Cancel
                        </Button>
                        <Button 
                          type="submit"
                          disabled={profileUpdateMutation.isPending}
                        >
                          {profileUpdateMutation.isPending ? (
                            <>
                              <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                              Saving...
                            </>
                          ) : (
                            'Save Changes'
                          )}
                        </Button>
                      </div>
                    </form>
                  </Form>
                </CardContent>
              </Card>
            </div>
          ) : (
            <>
              {/* Header with name and title */}
              <div className="mb-6">
                {user.fullName && (
                  <h2 className="text-xl font-semibold mb-1">{user.fullName}</h2>
                )}
                <div className="flex items-center">
                  <p className="text-gray-600">
                    {user.industry ? (
                      <span>{user.industry}</span>
                    ) : (
                      <span className="text-gray-400 italic">Add your industry in profile settings</span>
                    )}
                  </p>
                  <Button variant="ghost" size="sm" className="ml-2" onClick={() => setIsEditing(true)}>
                    <svg className="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                    Edit
                  </Button>
                </div>
              </div>
              
              {/* Bio Section */}
              <div className="mb-8">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-sm font-bold uppercase tracking-wider text-gray-700">PROFESSIONAL BIO</h2>
                </div>
                <div className="rounded-lg border border-gray-200 p-4">
                  <div className="text-gray-600">
                    {user.bio ? (
                      <p className="whitespace-pre-line">{user.bio}</p>
                    ) : (
                      <p className="text-gray-400 italic">No bio information added yet. Add a professional bio to help journalists understand your expertise.</p>
                    )}
                  </div>
                </div>
              </div>

              {/* Contact Information Section */}
              <div className="mb-8">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-sm font-bold uppercase tracking-wider text-gray-700">CONTACT INFORMATION</h2>
                </div>
                <div className="rounded-lg border border-gray-200 p-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <h3 className="text-sm font-medium text-gray-500 mb-1">Location</h3>
                    <p className="text-gray-700">{user.location || 'Not specified'}</p>
                  </div>
                  <div>
                    <h3 className="text-sm font-medium text-gray-500 mb-1">Email</h3>
                    <p className="text-gray-700">{user.email}</p>
                  </div>
                  <div>
                    <h3 className="text-sm font-medium text-gray-500 mb-1">Website</h3>
                    {user.website ? (
                      <a href={user.website} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">
                        {user.website.replace(/^https?:\/\//, '').replace(/^www\./, '')}
                      </a>
                    ) : (
                      <p className="text-gray-400 italic">Not specified</p>
                    )}
                  </div>
                  <div>
                    <h3 className="text-sm font-medium text-gray-500 mb-1">Industry</h3>
                    <p className="text-gray-700">{user.industry || 'Not specified'}</p>
                  </div>
                </div>
              </div>

              {/* Social Media Links */}
              <div className="mb-8">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-sm font-bold uppercase tracking-wider text-gray-700">SOCIAL MEDIA</h2>
                </div>
                <div className="rounded-lg border border-gray-200 p-4">
                  <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    {/* LinkedIn */}
                    <div className="flex items-center">
                      <div className="bg-blue-50 rounded-md p-2 mr-3">
                        <svg className="h-5 w-5 text-blue-700" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                        </svg>
                      </div>
                      {user.linkedIn ? (
                        <a href={user.linkedIn} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline text-sm font-medium">
                          LinkedIn Profile
                        </a>
                      ) : (
                        <p className="text-gray-400 italic text-sm">No LinkedIn profile added</p>
                      )}
                    </div>
                    
                    {/* X (formerly Twitter) */}
                    <div className="flex items-center">
                      <div className="bg-black rounded-md p-2 mr-3">
                        <svg className="h-5 w-5 text-white" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                      </div>
                      {user.twitter ? (
                        <a href={user.twitter} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline text-sm font-medium">
                          X Profile
                        </a>
                      ) : (
                        <p className="text-gray-400 italic text-sm">No X profile added</p>
                      )}
                    </div>
                    
                    {/* Instagram */}
                    <div className="flex items-center">
                      <div className="bg-purple-50 rounded-md p-2 mr-3">
                        <svg className="h-5 w-5 text-purple-700" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                        </svg>
                      </div>
                      {user.instagram ? (
                        <a href={user.instagram} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline text-sm font-medium">
                          Instagram Profile
                        </a>
                      ) : (
                        <p className="text-gray-400 italic text-sm">No Instagram profile added</p>
                      )}
                    </div>
                  </div>
                </div>
              </div>
              
              {/* Media Coverage Section */}
              <div className="mb-8">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-sm font-bold uppercase tracking-wider text-gray-700">MEDIA COVERAGE</h2>
                  <Button variant="ghost" size="sm">
                    + Add Media
                  </Button>
                </div>

                <div className="rounded-lg border border-gray-200 p-4">
                  {successfulPlacements && successfulPlacements.length > 0 ? (
                    <div className="grid grid-cols-1 gap-4">
                      {successfulPlacements.map((placement) => (
                        <div key={placement.id} className="border-b border-gray-100 pb-3 last:border-0 last:pb-0">
                          <h3 className="font-medium text-gray-900">{placement.articleTitle || 'Untitled Article'}</h3>
                          <div className="flex items-center mt-1 text-sm text-gray-500">
                            <span className="font-medium text-gray-600 mr-1">{placement.publication?.name || 'Publication'}</span>
                            <span>â€¢ {formatDate(placement.publicationDate || placement.createdAt)}</span>
                          </div>
                          <div className="mt-2">
                            {placement.articleUrl && (
                              <a href={placement.articleUrl} target="_blank" rel="noopener noreferrer" className="text-blue-600 text-sm font-medium flex items-center">
                                View article
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-3 w-3 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                </svg>
                              </a>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className="text-center py-8 px-4">
                      <p className="text-gray-500 mb-4">You don't have any media coverage yet. As you get quoted and featured in publications, they'll appear here.</p>
                      <Button variant="outline" size="sm" asChild>
                        <a href="/opportunities">Browse Opportunities</a>
                      </Button>
                    </div>
                  )}
                </div>
              </div>
              
              {/* Recent Quotes */}
              <div className="mb-8">
                <h2 className="text-sm font-bold uppercase tracking-wider text-gray-700 mb-4">RECENT QUOTES</h2>
                <div className="rounded-lg border border-gray-200 p-4">
                  <div className="text-center py-6">
                    <p className="text-gray-500 mb-4">No recent quotes yet. Your contributions to articles will appear here.</p>
                  </div>
                </div>
              </div>
              
              {/* Headshots/Media Photos */}
              <div className="mb-8">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-sm font-bold uppercase tracking-wider text-gray-700">MEDIA PHOTOS</h2>
                  <Button variant="ghost" size="sm">
                    + Add Photo
                  </Button>
                </div>
                <div className="rounded-lg border border-gray-200 p-4">
                  <div className="text-center py-6">
                    <p className="text-gray-500 mb-4">You haven't added any professional photos yet. Add headshots for journalists to use.</p>
                  </div>
                </div>
              </div>
              
              {/* Support Section */}
              <div className="mb-8 rounded-lg border border-gray-200 p-6 bg-blue-50">
                <h2 className="text-lg font-medium mb-2">Need help with your profile?</h2>
                <p className="text-gray-600 mb-4">Our team can help optimize your profile to increase your chances of getting quoted.</p>
                <div className="flex flex-wrap gap-3">
                  <Button variant="default" size="sm" asChild>
                    <a href="https://calendly.com/quotebid/consultation" target="_blank" rel="noopener noreferrer">
                      Book a Call
                    </a>
                  </Button>
                  <Button variant="outline" size="sm" asChild>
                    <a href="mailto:support@quotebid.com">
                      Email Support
                    </a>
                  </Button>
                </div>
              </div>
            </>
          )}
        </div>
      </div>

      {/* Subscription Modal */}
      <Dialog open={subscriptionModalOpen} onOpenChange={setSubscriptionModalOpen}>
        <DialogContent className="sm:max-w-lg">
          <DialogHeader>
            <DialogTitle>Manage Your Subscription</DialogTitle>
            <DialogDescription>
              View details of your current subscription plan and make changes.
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4 py-4">
            {isLoadingSubscription ? (
              <div className="flex justify-center py-8">
                <Loader2 className="h-8 w-8 animate-spin text-border" />
              </div>
            ) : subscription ? (
              <>
                <div className="flex justify-between items-center">
                  <div>
                    <h3 className="text-xl font-bold">QuoteBid {subscription.isPremium ? 'Premium' : 'Basic'}</h3>
                    <p className="text-sm text-gray-500">
                      Status: <span className={`font-medium ${subscription.status === 'active' ? 'text-green-600' : 'text-amber-600'}`}>
                        {subscription.status === 'active' ? 'Active' : 'Inactive'}
                      </span>
                    </p>
                    {subscription.expiresAt && (
                      <p className="text-sm text-gray-500 mt-1">
                        {subscription.status === 'active' ? 'Next billing date' : 'Expires'}: {formatDate(subscription.expiresAt)}
                      </p>
                    )}
                  </div>
                  <div className="border border-gray-200 rounded-lg p-3 text-center">
                    <p className="text-xs text-gray-500">Monthly Price</p>
                    <p className="text-2xl font-bold">
                      $99.99
                    </p>
                  </div>
                </div>
                
                <div className="space-y-2">
                  <h4 className="font-medium text-gray-900">Plan Includes:</h4>
                  <ul className="space-y-2">
                    <li className="flex items-start">
                      <CheckCircle className="h-5 w-5 text-green-500 mr-2 shrink-0 mt-0.5" />
                      <span>Unlimited pitches to media opportunities</span>
                    </li>
                    <li className="flex items-start">
                      <CheckCircle className="h-5 w-5 text-green-500 mr-2 shrink-0 mt-0.5" />
                      <span>Priority matching with journalists</span>
                    </li>
                    <li className="flex items-start">
                      <CheckCircle className="h-5 w-5 text-green-500 mr-2 shrink-0 mt-0.5" />
                      <span>Access to premium tier opportunities</span>
                    </li>
                    <li className="flex items-start">
                      <CheckCircle className="h-5 w-5 text-green-500 mr-2 shrink-0 mt-0.5" />
                      <span>Professional profile with social links</span>
                    </li>
                  </ul>
                </div>
              </>
            ) : (
              <div className="text-center py-4">
                <p className="text-gray-500">No active subscription found.</p>
                <Button className="mt-4">
                  Subscribe Now
                </Button>
              </div>
            )}
          </div>
          <DialogFooter className="flex flex-col-reverse sm:flex-row sm:justify-between sm:space-x-2">
            {subscription?.status === 'active' && (
              <Button 
                variant="outline" 
                onClick={() => {
                  setSubscriptionModalOpen(false);
                  setCancelModalOpen(true);
                }}
              >
                Cancel Subscription
              </Button>
            )}
            <Button onClick={() => setSubscriptionModalOpen(false)}>
              Close
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Cancel Subscription Confirmation Modal */}
      <Dialog open={cancelModalOpen} onOpenChange={setCancelModalOpen}>
        <DialogContent className="sm:max-w-md">
          <DialogHeader>
            <DialogTitle>Cancel Your Subscription?</DialogTitle>
            <DialogDescription>
              Are you sure you want to cancel your QuoteBid subscription?
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4 py-4">
            <div className="space-y-2">
              <h4 className="font-medium text-gray-900">What happens when you cancel:</h4>
              <ul className="space-y-2">
                <li className="flex items-start">
                  <AlertCircle className="h-5 w-5 text-amber-500 mr-2 shrink-0 mt-0.5" />
                  <span>You'll continue to have access until the end of your current billing period.</span>
                </li>
                <li className="flex items-start">
                  <AlertCircle className="h-5 w-5 text-amber-500 mr-2 shrink-0 mt-0.5" />
                  <span>You will lose access to premium opportunities after your subscription ends.</span>
                </li>
                <li className="flex items-start">
                  <AlertCircle className="h-5 w-5 text-amber-500 mr-2 shrink-0 mt-0.5" />
                  <span>You can resubscribe at any time.</span>
                </li>
              </ul>
            </div>
          </div>
          <DialogFooter className="flex flex-col-reverse sm:flex-row sm:justify-between sm:space-x-2">
            <Button 
              variant="outline" 
              onClick={() => setCancelModalOpen(false)}
            >
              Keep Subscription
            </Button>
            <Button 
              variant="destructive" 
              onClick={handleCancelSubscription}
              disabled={cancellingSubscription}
            >
              {cancellingSubscription ? (
                <>
                  <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                  Cancelling...
                </>
              ) : (
                'Confirm Cancellation'
              )}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}