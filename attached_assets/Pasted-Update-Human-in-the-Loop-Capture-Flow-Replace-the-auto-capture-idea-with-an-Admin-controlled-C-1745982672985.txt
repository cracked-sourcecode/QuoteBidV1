Update â€” â€œHuman-in-the-Loop Captureâ€ Flow
(Replace the auto-capture idea with an Admin-controlled â€œCharge Nowâ€ button once coverage is verified.)

1â€‚New Lifecycle States

Bid state	Who triggers it	What it means
pending	Expert	Bid placed, card authorized (requires_capture).
selected	Reporter	Pitch chosen; still only a hold.
coverage_shared	Internal staff marks article URL visible to client.	
ready_to_capture	Billing manager queue after coverage is live & client notified.	
captured	Billing manager clicks Charge Now; Stripe capture succeeds.	
Add two columns to bids:

sql
Copy
Edit
ALTER TABLE bids ADD COLUMN coverage_url TEXT;
ALTER TABLE bids ADD COLUMN state TEXT DEFAULT 'pending';
2â€‚Database & API tweaks
2.1 Store the PaymentIntent ID
Already saved as intent_id when the bid is authorized.

2.2 Admin endpoints
ruby
Copy
Edit
GET  /admin/billing/queue           -> all bids WHERE state='ready_to_capture'
POST /admin/billing/:bidId/capture  -> captures Stripe PI, sets state='captured'
POST /admin/billing/:bidId/mark-ready
      body: { coverage_url }        -> sets state='ready_to_capture', saves URL
3â€‚Admin UI slice

Route	Component	Key actions
/admin/coverage	CoverageVerifier table	Paste article URL âœ â€œMark Ready for Billingâ€
/admin/billing	BillingQueue table	Shows outlet, client, bid $, Charge Now button
BillingQueue Row
tsx
Copy
Edit
<Button onClick={() => captureBid(bidId)}
        className="bg-green-600 hover:bg-green-700">
  Charge Now
</Button>
Captures the PI:

ts
Copy
Edit
await fetch(`/admin/billing/${bidId}/capture`, { method:'POST' })
toast.success('Payment captured âœ…')
4â€‚Stripe code snippet (server)
ts
Copy
Edit
import Stripe from 'stripe';
const stripe = new Stripe(process.env.STRIPE_SECRET!);

export async function capturePayment(intentId: string) {
  const intent = await stripe.paymentIntents.capture(intentId);
  // intent.status === 'succeeded' â†’ update DB
}
Docs: â€œUsing authorization and capture with PaymentIntentsâ€
â†’ /payments/place-a-hold-on-a-payment-method (authorize)
â†’ /api/payment_intents/capture (manual capture)

5â€‚Prompt block for Replit AI
bash
Copy
Edit
ğŸ†•  ADMIN-CAPTURE FEATURE
Create the following:

1. DB migration: add coverage_url & state columns to bids.

2. API routes (Next.js app-router):
   â€¢ POST /api/admin/bids/[id]/mark-ready  -> update state='ready_to_capture'
   â€¢ POST /api/admin/bids/[id]/capture     -> stripe.capture + state='captured'
   Both routes protected by simple JWT (TODO comment).

3. /admin/coverage page
   â€¢ Table lists bids where state='selected'
   â€¢ Input field for coverage URL
   â€¢ â€œMark Ready for Billingâ€ button (calls mark-ready)

4. /admin/billing page
   â€¢ Table lists bids state='ready_to_capture'
   â€¢ Shows outlet, expert, amount, coverage_url
   â€¢ â€œCharge Nowâ€ button â†’ POST capture route
   â€¢ Toast success / error.

5. Comment at top of capture route:
   // Card was authorized via PaymentIntent(capture_method='manual').
   // We capture only after human verification of live coverage.

Generate code with Tailwind + shadcn/ui tables and buttons.
Give this block to Replitâ€™s Ghostwriter; it will scaffold the admin screens, endpoints, and Stripe-capture stub so your billing manager can click a single button to settle the payment once coverage is confirmed live.